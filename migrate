#!/usr/bin/env php
<?php

/**
 * Comando de migração
 * Permite executar migrações via linha de comando
 */

require_once __DIR__ . '/vendor/autoload.php';

use App\Infrastructure\Database\MigrationManager;
use App\Infrastructure\Database\DatabaseManager;

// Carrega variáveis de ambiente
if (file_exists(__DIR__ . '/.env')) {
    $lines = file(__DIR__ . '/.env', FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    foreach ($lines as $line) {
        if (strpos(trim($line), '#') === 0) {
            continue;
        }
        list($name, $value) = explode('=', $line, 2);
        $_ENV[trim($name)] = trim($value);
    }
}

// Inicializa o banco de dados
DatabaseManager::initialize();

// Processa argumentos da linha de comando
$command = $argv[1] ?? 'help';
$migrationManager = new MigrationManager();

switch ($command) {
    case 'migrate':
        echo "Executando migrações...\n";
        $migrationManager->migrate();
        echo "Migrações executadas com sucesso!\n";
        break;
        
    case 'rollback':
        $steps = isset($argv[2]) ? (int)$argv[2] : 1;
        echo "Desfazendo {$steps} migração(ões)...\n";
        $migrationManager->rollback($steps);
        echo "Rollback executado com sucesso!\n";
        break;
        
    case 'refresh':
        echo "Refazendo todas as migrações...\n";
        $migrationManager->refresh();
        echo "Migrações refeitas com sucesso!\n";
        break;
        
    case 'status':
        echo "Status das migrações:\n";
        $status = $migrationManager->status();
        
        if (empty($status)) {
            echo "Nenhuma migração encontrada.\n";
        } else {
            echo str_pad('Migração', 50) . " | Status\n";
            echo str_repeat('-', 60) . "\n";
            
            foreach ($status as $migration) {
                $statusText = $migration['executed'] ? 'Executada' : 'Pendente';
                echo str_pad($migration['name'], 50) . " | {$statusText}\n";
            }
        }
        break;
        
    case 'make':
        if (!isset($argv[2])) {
            echo "Erro: Nome da migração é obrigatório.\n";
            echo "Uso: php migrate make nome_da_migracao\n";
            exit(1);
        }
        
        $name = $argv[2];
        $filename = $migrationManager->createMigration($name);
        echo "Migração criada: {$filename}\n";
        break;
        
    case 'help':
    default:
        echo "Comandos de migração disponíveis:\n";
        echo "  migrate          - Executa todas as migrações pendentes\n";
        echo "  rollback [steps] - Desfaz migrações (padrão: 1 step)\n";
        echo "  refresh          - Desfaz todas e executa novamente\n";
        echo "  status           - Mostra o status das migrações\n";
        echo "  make <name>      - Cria uma nova migração\n";
        echo "  help             - Mostra esta ajuda\n";
        echo "\nExemplos:\n";
        echo "  php migrate migrate\n";
        echo "  php migrate rollback 2\n";
        echo "  php migrate make create_users_table\n";
        break;
}